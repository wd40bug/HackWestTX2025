@page "/"
@using System.Runtime.InteropServices
@using System.Security.Principal
@rendermode InteractiveServer

<PageTitle>LOVE-ME-NOT</PageTitle>

<h1 class="titan-one title">LOVE-ME-NOT</h1>
@switch (state)
{
    case Page.UploadFile:
        <UploadFile OnLove="@LoveCalculated" discord_token="@discord_token" />
        ; break;
    case Page.Loading:
        <Loading Progress="@progress" Reciprocal="@reciprocal" />
        ; break;
    case Page.Results:
        @if (results is not null)
        {
            <Results results="@results" Reciprocal="@ReciprocalCallback" Home="@HomeCallBack" />
        }
        else
        {
            <Error returnToHome="() => { state = Page.UploadFile; }" />
        }

; break;
}


@code {
    private string discord_token = "";
    private bool reciprocal = false;
    private double progress;
    public async Task update_progress(double new_progress)
    {
        progress = new_progress;
        await InvokeAsync(StateHasChanged);
    }

    enum Page
    {
        UploadFile,
        Loading,
        Results,
    }
    Page state = Page.UploadFile;
    LoveResults? results;
    private List<Message> parse_json = new List<Message>();


    private async Task calculate_love()
    {
        Console.WriteLine("Number of messages: " + parse_json.Count());
        ChatLog clog = new ChatLog(parse_json);
        results = await Task.Run(() => clog.FindStats((Func<double, Task>)update_progress));
        state = Page.Results;
        await InvokeAsync(StateHasChanged);
        Console.WriteLine("Finished Calculating Love!!!");
    }
    public async void LoveCalculated((IBrowserFile file, string token) args)
    {
        discord_token = args.token;
        reciprocal = false;
        Console.WriteLine("Love calculated");
        state = Page.Loading;
        await InvokeAsync(StateHasChanged);
        parse_json = await FileHandle.ParseJson(args.file, args.token);
        await calculate_love();
    }

    public async void ReciprocalCallback()
    {
        reciprocal = !reciprocal;
        progress = 0;
        state = Page.Loading;
        await InvokeAsync(StateHasChanged);
        parse_json = parse_json.Select(i => { Message n = i; n.Self = !i.Self; return n; }).ToList();
        await calculate_love();
    }

    public async void HomeCallBack()
    {
        progress = 0;
        state = Page.UploadFile;
        await InvokeAsync(StateHasChanged);
    }
}

<style>
    .title {
        font-size: 100pt;
        color:
            @BlazorTest.ColorConstants.rose
        ;
    }

    body {
        background-color:
            @BlazorTest.ColorConstants.mint
        ;
        display: flex;
        justify-content: center;
        text-align: center;
    }
</style>